<Window x:Class="ScrapSAE.Desktop.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ScrapSAE.Desktop.Infrastructure"
        mc:Ignorable="d"
        Title="ScrapSAE - Consola"
        Height="900"
        Width="1300"
        WindowStartupLocation="CenterScreen"
        Loaded="MainWindow_OnLoaded">
    <Grid Background="#F3F5F8">
        <Grid.Resources>
            <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
            <local:NegateBooleanConverter x:Key="NegateBool" />
            <Style TargetType="Button">
                <Setter Property="Padding" Value="12,8" />
                <Setter Property="Margin" Value="0,0,8,0" />
                <Setter Property="Background" Value="#2563EB" />
                <Setter Property="Foreground" Value="White" />
                <Setter Property="BorderBrush" Value="#1D4ED8" />
                <Setter Property="BorderThickness" Value="1" />
                <Setter Property="Cursor" Value="Hand" />
                <Setter Property="FontWeight" Value="Medium" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="6"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Opacity" Value="0.9" />
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter Property="Opacity" Value="0.8" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
            <Style TargetType="TextBox">
                <Setter Property="Margin" Value="0,6,0,12" />
                <Setter Property="Padding" Value="10" />
                <Setter Property="BorderBrush" Value="#D1D5DB" />
                <Setter Property="BorderThickness" Value="1" />
                <Setter Property="Background" Value="White" />
                <Setter Property="FontSize" Value="13" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="TextBox">
                            <Border Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="4">
                                <ScrollViewer x:Name="PART_ContentHost" Margin="{TemplateBinding Padding}" />
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
            <Style TargetType="DataGrid">
                <Setter Property="RowBackground" Value="White" />
                <Setter Property="AlternatingRowBackground" Value="#F9FAFB" />
                <Setter Property="GridLinesVisibility" Value="Horizontal" />
                <Setter Property="BorderBrush" Value="#E5E7EB" />
                <Setter Property="BorderThickness" Value="1" />
            </Style>
            <Style TargetType="TabControl">
                <Setter Property="Background" Value="Transparent" />
                <Setter Property="BorderThickness" Value="0" />
            </Style>
            <Style TargetType="TabItem">
                <Setter Property="Padding" Value="12,6" />
                <Setter Property="Margin" Value="0,0,2,0" />
            </Style>
        </Grid.Resources>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Border Background="#111827" Padding="20">
            <DockPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8B7;" Foreground="#3B82F6" FontSize="28" Margin="0,0,12,0" VerticalAlignment="Center" />
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="ScrapSAE Console" Foreground="White" FontSize="22" FontWeight="Bold" />
                        <TextBlock Text="Sistema de Scraping Automatizado" Foreground="#9CA3AF" FontSize="11" Margin="0,2,0,0" />
                    </StackPanel>
                </StackPanel>
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                    <Border Background="#1F2937" CornerRadius="4" Padding="8,4" Margin="0,0,8,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE81C;" Foreground="#10B981" FontSize="14" Margin="0,0,6,0" VerticalAlignment="Center" />
                            <TextBlock Text="{Binding Sites.Count}" Foreground="White" FontWeight="SemiBold" VerticalAlignment="Center" />
                            <TextBlock Text=" proveedores" Foreground="#9CA3AF" FontSize="11" VerticalAlignment="Center" Margin="2,0,0,0" />
                        </StackPanel>
                    </Border>
                    <Button Content="Refrescar"
                            Command="{Binding LoadAllCommand}"
                            Background="#F59E0B"
                            BorderBrush="#D97706" />
                </StackPanel>
            </DockPanel>
        </Border>

        <Border Grid.Row="1" Background="#F9FAFB" Padding="12" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal">
                <Button Click="Nav_Click" Tag="0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE1DB;" Margin="0,0,6,0" />
                        <TextBlock Text="Health" />
                    </StackPanel>
                </Button>
                <Button Click="Nav_Click" Tag="1">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE115;" Margin="0,0,6,0" />
                        <TextBlock Text="Configuración" />
                    </StackPanel>
                </Button>
                <Button Click="Nav_Click" Tag="2">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE13D;" Margin="0,0,6,0" />
                        <TextBlock Text="Proveedores" />
                    </StackPanel>
                </Button>
                <Button Click="Nav_Click" Tag="3">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE1CF;" Margin="0,0,6,0" />
                        <TextBlock Text="Staging" />
                    </StackPanel>
                </Button>
                <Button Click="Nav_Click" Tag="4">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE158;" Margin="0,0,6,0" />
                        <TextBlock Text="Mapeo" />
                    </StackPanel>
                </Button>
                <Button Click="Nav_Click" Tag="5">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE133;" Margin="0,0,6,0" />
                        <TextBlock Text="Logs" />
                    </StackPanel>
                </Button>
                <Button Click="Nav_Click" Tag="6">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE125;" Margin="0,0,6,0" />
                        <TextBlock Text="App Logs" />
                    </StackPanel>
                </Button>
                <Button Click="Nav_Click" Tag="7">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE12A;" Margin="0,0,6,0" />
                        <TextBlock Text="Reportes" />
                    </StackPanel>
                </Button>
                <Button Click="Nav_Click" Tag="8">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE135;" Margin="0,0,6,0" />
                        <TextBlock Text="Scraping" />
                    </StackPanel>
                </Button>
                <Button Click="Nav_Click" Tag="9">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE126;" Margin="0,0,6,0" />
                        <TextBlock Text="SAE" />
                    </StackPanel>
                </Button>
                <Button Command="{Binding ExitCommand}" Background="#EF4444" BorderBrush="#B91C1C" Margin="12,0,0,0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE117;" Margin="0,0,6,0" />
                        <TextBlock Text="Salir" />
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>

        <TabControl Grid.Row="2" Margin="16" SelectedIndex="{Binding SelectedTabIndex}">
            <TabControl.Resources>
                <Style TargetType="TabItem">
                    <Setter Property="Visibility" Value="Collapsed" />
                    <Setter Property="Height" Value="0" />
                    <Setter Property="Width" Value="0" />
                </Style>
            </TabControl.Resources>
            <TabItem Header="Health">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <Button Content="Probar Backend" Command="{Binding TestBackendCommand}" Margin="0,0,8,0" />
                        <Button Content="Ejecutar Diagnóstico" Command="{Binding RunDiagnosticsCommand}" />
                    </StackPanel>
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Border Grid.Column="0" Background="White" Padding="12" Margin="0,0,8,0" CornerRadius="6" BorderBrush="#E5E7EB" BorderThickness="1">
                            <StackPanel>
                                <TextBlock Text="Estado Backend" FontWeight="SemiBold" />
                                <TextBlock Text="{Binding BackendStatus}" FontSize="16" />
                                <TextBlock Text="Supabase" FontWeight="SemiBold" Margin="0,12,0,0" />
                                <TextBlock Text="{Binding SupabaseStatus}" FontSize="16" />
                                <TextBlock Text="SAE SDK" FontWeight="SemiBold" Margin="0,12,0,0" />
                                <TextBlock Text="{Binding SaeStatus}" FontSize="16" />
                                <TextBlock Text="Base de datos" FontWeight="SemiBold" Margin="0,12,0,0" />
                                <TextBlock Text="{Binding DatabaseStatus}" FontSize="16" />
                            </StackPanel>
                        </Border>
                        <Border Grid.Column="1" Background="White" Padding="12" Margin="8,0,0,0" CornerRadius="6" BorderBrush="#E5E7EB" BorderThickness="1">
                            <StackPanel>
                                <TextBlock Text="Detalles" FontWeight="SemiBold" />
                                <TextBlock Text="{Binding DiagnosticsResult.SupabaseMessage}" TextWrapping="Wrap" Margin="0,8,0,0" />
                                <TextBlock Text="{Binding DiagnosticsResult.SaeMessage}" TextWrapping="Wrap" Margin="0,8,0,0" />
                                <TextBlock Text="Última verificación (UTC)" FontWeight="SemiBold" Margin="0,12,0,0" />
                                <TextBlock Text="{Binding DiagnosticsResult.CheckedAtUtc}" />
                            </StackPanel>
                        </Border>
                    </Grid>
                </Grid>
            </TabItem>

            <TabItem Header="Configuración">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <Button Content="Cargar" Command="{Binding LoadSettingsCommand}" Margin="0,0,8,0" />
                        <Button Content="Guardar" Command="{Binding SaveSettingsCommand}" Margin="0,0,8,0" />
                        <Button Content="Diagnóstico" Command="{Binding RunDiagnosticsCommand}" />
                    </StackPanel>
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Border Grid.Column="0" Background="White" Padding="12" Margin="0,0,8,0" CornerRadius="6" BorderBrush="#E5E7EB" BorderThickness="1">
                            <StackPanel>
                                <TextBlock Text="Supabase URL" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SupabaseUrl}" />
                                <TextBlock Text="Supabase Service Key" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SupabaseServiceKey}" />
                                <TextBlock Text="SAE SDK Path" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeSdkPath}" />
                                <TextBlock Text="SAE DB Host" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeDbHost}" />
                                <TextBlock Text="SAE DB Path (FDB)" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeDbPath}" AutomationProperties.AutomationId="SaeDbPath" AutomationProperties.Name="SaeDbPath" />
                                <TextBlock Text="SAE DB Port" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeDbPort}" />
                                <TextBlock Text="SAE DB Charset" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeDbCharset}" />
                                <TextBlock Text="SAE DB Dialect" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeDbDialect}" />
                                <TextBlock Text="SAE Default Line Code" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeDefaultLineCode}" />
                            </StackPanel>
                        </Border>
                        <Border Grid.Column="1" Background="White" Padding="12" Margin="8,0,0,0" CornerRadius="6" BorderBrush="#E5E7EB" BorderThickness="1">
                            <StackPanel>
                                <TextBlock Text="Usuario SAE" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeUser}" />
                                <TextBlock Text="Password SAE" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaePassword}" />
                                <TextBlock Text="Usuario DB" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeDbUser}" />
                                <TextBlock Text="Password DB" FontWeight="SemiBold" />
                                <TextBox Text="{Binding SaeDbPassword}" />
                                <TextBlock Text="Nota" FontWeight="SemiBold" Margin="0,12,0,0" />
                                <TextBlock Text="Guarda la configuración y reinicia el backend para aplicar cambios." TextWrapping="Wrap" />
                            </StackPanel>
                        </Border>
                    </Grid>
                </Grid>
            </TabItem>
            <TabItem Header="Proveedores">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="Crear" Command="{Binding CreateSiteCommand}" Margin="0,0,8,0" />
                        <Button Content="Actualizar" Command="{Binding UpdateSiteCommand}" Margin="0,0,8,0" />
                        <Button Content="Eliminar" Command="{Binding DeleteSiteCommand}" />
                    </StackPanel>
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding Sites}"
                              SelectedItem="{Binding SelectedSite}"
                              AutoGenerateColumns="True"
                              IsReadOnly="False"
                              CanUserAddRows="False"
                              Margin="0,4,0,0" />
                </Grid>
            </TabItem>

            <TabItem Header="Staging Productos">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="Refrescar" Command="{Binding LoadAllCommand}" Margin="0,0,8,0" />
                        <Button Content="Eliminar" Command="{Binding DeleteStagingCommand}" />
                        <Button Content="Enviar a SAE" Command="{Binding SendSelectedToSaeCommand}" Margin="8,0,0,0" Background="#10B981" Foreground="White" />
                    </StackPanel>

                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ListBox ItemsSource="{Binding StagingProducts}" 
                                 SelectedItem="{Binding SelectedStagingProduct}"
                                 BorderThickness="0" Background="Transparent">
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Margin="0,0,10,0" />
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <ContentPresenter />
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="#E5E7EB" BorderThickness="1" CornerRadius="8" Background="White" Margin="8" Width="280" Padding="12">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True">
                                                        <Setter Property="BorderBrush" Value="#3B82F6" />
                                                        <Setter Property="BorderThickness" Value="2" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="*" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <!-- Status Badge -->
                                            <Border HorizontalAlignment="Right" Padding="6,2" CornerRadius="4">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Background" Value="#F3F4F6" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Status}" Value="pending">
                                                                <Setter Property="Background" Value="#FEF3C7" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Status}" Value="synced">
                                                                <Setter Property="Background" Value="#D1FAE5" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding Status}" FontSize="10" FontWeight="Bold">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Foreground" Value="#374151" />
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Status}" Value="pending">
                                                                    <Setter Property="Foreground" Value="#92400E" />
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Status}" Value="synced">
                                                                    <Setter Property="Foreground" Value="#065F46" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </Border>

                                            <!-- Image Placeholder / AI Image -->
                                            <Border Grid.Row="1" Height="150" Background="#F9FAFB" Margin="0,8">
                                                <Image Source="{Binding ImageUrl}" Stretch="Uniform" />
                                            </Border>

                                            <StackPanel Grid.Row="2">
                                                <TextBlock Text="{Binding Sku}" FontSize="11" Foreground="#6B7280" />
                                                <TextBlock Text="{Binding Title}" FontSize="14" FontWeight="Bold" TextWrapping="Wrap" Margin="0,4" />
                                                <TextBlock Text="{Binding Price, StringFormat={}{0:C}}" FontSize="16" Foreground="#111827" FontWeight="SemiBold" />
                                            </StackPanel>

                                            <!-- Specs List -->
                                            <ItemsControl Grid.Row="3" ItemsSource="{Binding AllSpecifications}" Margin="0,8">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid Margin="0,2">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="2*" />
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="{Binding Key}" FontSize="10" Foreground="#6B7280" TextWrapping="Wrap" />
                                                            <TextBlock Grid.Column="1" Text="{Binding Value}" FontSize="10" Foreground="#374151" FontWeight="Medium" Margin="4,0,0,0" TextWrapping="Wrap" />
                                                        </Grid>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>

                                            <Button Grid.Row="4" Content="Seleccionar" 
                                                    Command="{Binding DataContext.CreateReportCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                    CommandParameter="{Binding}" 
                                                    Margin="0,8,0,0" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Grid>
            </TabItem>

            <TabItem Header="Mapeo Categorías">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="Crear" Command="{Binding CreateCategoryCommand}" Margin="0,0,8,0" />
                        <Button Content="Actualizar" Command="{Binding UpdateCategoryCommand}" Margin="0,0,8,0" />
                        <Button Content="Eliminar" Command="{Binding DeleteCategoryCommand}" />
                    </StackPanel>
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding CategoryMappings}"
                              SelectedItem="{Binding SelectedCategoryMapping}"
                              AutoGenerateColumns="True"
                              IsReadOnly="False"
                              CanUserAddRows="False"
                              Margin="0,4,0,0" />
                </Grid>
            </TabItem>

            <TabItem Header="Logs">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="Crear" Command="{Binding CreateSyncLogCommand}" Margin="0,0,8,0" />
                        <Button Content="Actualizar" Command="{Binding UpdateSyncLogCommand}" Margin="0,0,8,0" />
                        <Button Content="Eliminar" Command="{Binding DeleteSyncLogCommand}" />
                    </StackPanel>
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding SyncLogs}"
                              SelectedItem="{Binding SelectedSyncLog}"
                              AutoGenerateColumns="True"
                              IsReadOnly="False"
                              CanUserAddRows="False"
                              Margin="0,4,0,0" />
                </Grid>
            </TabItem>
            <TabItem Header="App Logs">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="Refrescar" Command="{Binding RefreshAppLogsCommand}" />
                        <TextBlock Text="Archivo:" Margin="8,0,4,0" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding AppLogPath}" VerticalAlignment="Center" />
                    </StackPanel>
                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding AppLogs}"
                             FontFamily="Consolas"
                             FontSize="12"
                             Background="White"
                             BorderBrush="#E5E7EB"
                             BorderThickness="1" />
                </Grid>
            </TabItem>

            <TabItem Header="Reportes">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="Crear" Command="{Binding CreateReportCommand}" Margin="0,0,8,0" />
                        <Button Content="Actualizar" Command="{Binding UpdateReportCommand}" Margin="0,0,8,0" />
                        <Button Content="Eliminar" Command="{Binding DeleteReportCommand}" />
                    </StackPanel>
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding ExecutionReports}"
                              SelectedItem="{Binding SelectedExecutionReport}"
                              AutoGenerateColumns="True"
                              IsReadOnly="False"
                              CanUserAddRows="False"
                              Margin="0,4,0,0" />
                </Grid>
            </TabItem>

            <TabItem Header="Scraping">
                <Grid Margin="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- SIDEBAR (Column 0) - Now top-side config -->
                    <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" Margin="0,0,16,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="1*" />
                                <ColumnDefinition Width="1*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!-- Panel de Control Principal (Row 0, Col 0) -->
                            <Border Grid.Row="0" Grid.Column="0" Background="White" Padding="12" CornerRadius="6" BorderBrush="#E5E7EB" BorderThickness="1" Margin="0,0,6,12">
                                <StackPanel>
                                    <TextBlock Text="Proveedor" FontWeight="SemiBold" Margin="0,0,0,4" />
                                    <ComboBox ItemsSource="{Binding Sites}" 
                                              SelectedItem="{Binding SelectedSite}" 
                                              DisplayMemberPath="Name" 
                                              Margin="0,0,0,8" />
                                    
                                    <TextBlock Text="Acciones" FontWeight="SemiBold" Margin="0,0,0,4" />
                                    <Grid Margin="0,0,0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        
                                        <Button Grid.Row="0" Grid.Column="0" Content="Iniciar" Command="{Binding RunScrapingCommand}" Background="#10B981" BorderBrush="#059669" Margin="0,0,4,4" Height="28"/>
                                        <Button Grid.Row="0" Grid.Column="1" Content="Detener" Command="{Binding StopScrapingCommand}" Background="#EF4444" BorderBrush="#DC2626" Margin="4,0,0,4" Height="28"/>
                                        <Button Grid.Row="1" Grid.Column="0" Content="Pausar" Command="{Binding PauseScrapingCommand}" Background="#F59E0B" BorderBrush="#D97706" Margin="0,0,4,0" Height="28"/>
                                        <Button Grid.Row="1" Grid.Column="1" Content="Reanudar" Command="{Binding ResumeScrapingCommand}" Background="#3B82F6" BorderBrush="#2563EB" Margin="4,0,0,0" Height="28"/>
                                    </Grid>

                                    <Button Content="Confirmar Login Manual" Command="{Binding ConfirmLoginCommand}" Background="#8B5CF6" BorderBrush="#7C3AED" Margin="0,0,0,4" Height="28" Visibility="{Binding ManualLoginEnabled, Converter={StaticResource BoolToVisibility}}" />
                                    <Button Content="Refrescar logs" Command="{Binding RefreshLogsCommand}" Margin="0,0,0,4" Height="24" FontSize="11" />
                                </StackPanel>
                            </Border>

                            <!-- Estadísticas Compactas (Row 0, Col 1) -->
                            <Border Grid.Row="0" Grid.Column="1" Background="White" Padding="12" CornerRadius="6" BorderBrush="#E5E7EB" BorderThickness="1" Margin="6,0,0,12">
                                <StackPanel>
                                    <TextBlock Text="Estadísticas de Ejecución" FontWeight="SemiBold" Margin="0,0,0,8" />
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        
                                        <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,4">
                                            <TextBlock Text="Encontrados" FontSize="11" Foreground="#1E40AF" />
                                            <TextBlock Text="{Binding ScrapeResult.ProductsFound}" FontWeight="Bold" Foreground="#1E3A8A" FontSize="16" />
                                        </StackPanel>
                                        <StackPanel Grid.Row="0" Grid.Column="1" Margin="8,0,0,4">
                                            <TextBlock Text="Creados" FontSize="11" Foreground="#059669" />
                                            <TextBlock Text="{Binding ScrapeResult.ProductsCreated}" FontWeight="Bold" Foreground="#047857" FontSize="16" />
                                        </StackPanel>
                                        <StackPanel Grid.Row="1" Grid.Column="0">
                                            <TextBlock Text="Actualizados" FontSize="11" Foreground="#D97706" />
                                            <TextBlock Text="{Binding ScrapeResult.ProductsUpdated}" FontWeight="Bold" Foreground="#B45309" FontSize="16" />
                                        </StackPanel>
                                        <StackPanel Grid.Row="1" Grid.Column="1" Margin="8,0,0,0">
                                            <TextBlock Text="Omitidos" FontSize="11" Foreground="#6B7280" />
                                            <TextBlock Text="{Binding ScrapeResult.ProductsSkipped}" FontWeight="Bold" Foreground="#4B5563" FontSize="16" />
                                        </StackPanel>
                                    </Grid>
                                    <Separator Margin="0,6" />
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Duración:" FontSize="11" Foreground="#7C3AED" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                        <TextBlock Text="{Binding ScrapeResult.DurationMs, StringFormat={}{0} ms}" FontWeight="SemiBold" Foreground="#6D28D9" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Configuración (Row 1, Col 0) -->
                            <Border Grid.Row="1" Grid.Column="0" Background="#F3F4F6" Padding="12" CornerRadius="6" BorderBrush="#D1D5DB" BorderThickness="1" Margin="0,0,6,12">
                                <StackPanel>
                                    <TextBlock Text="Configuración" FontWeight="SemiBold" Margin="0,0,0,4" />
                                    
                                    <UniformGrid Columns="2">
                                        <StackPanel Margin="0,0,4,0">
                                            <TextBlock Text="Modo" FontSize="10" Foreground="#4B5563" />
                                            <ComboBox SelectedValue="{Binding ScrapingMode}" SelectedValuePath="Content" Height="24" FontSize="11">
                                                <ComboBoxItem Content="Tradicional" />
                                                <ComboBoxItem Content="Familias (Festo)" />
                                            </ComboBox>
                                        </StackPanel>
                                        <CheckBox Content="Login manual" IsChecked="{Binding ManualLoginEnabled}" VerticalAlignment="Center" FontSize="11" Margin="4,10,0,0" />
                                    </UniformGrid>

                                    <Grid Margin="0,8,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <CheckBox Content="Headless" IsChecked="{Binding HeadlessEnabled}" IsEnabled="{Binding ManualLoginEnabled, Converter={StaticResource NegateBool}}" FontSize="10" />
                                            <CheckBox Content="Mantener" IsChecked="{Binding KeepBrowserOpen}" FontSize="10" />
                                        </StackPanel>
                                        <StackPanel Grid.Column="1">
                                            <CheckBox Content="Screenshot IA" IsChecked="{Binding UseScreenshotFallback}" FontSize="10" />
                                            <Button Content="Analizar IA" Command="{Binding AnalyzeSelectorsCommand}" Height="20" FontSize="10" Margin="0,2,0,0"/>
                                        </StackPanel>
                                    </Grid>
                                    
                                    <TextBlock Text="Estado:" FontWeight="SemiBold" Margin="0,8,0,2" FontSize="11" />
                                    <TextBlock Text="{Binding ScrapeStatusText}" Foreground="#2563EB" TextWrapping="Wrap" FontSize="11" />
                                </StackPanel>
                            </Border>

                            <!-- URLs de Aprendizaje (Row 1, Col 1) -->
                            <Border Grid.Row="1" Grid.Column="1" Background="#FFFBEB" Padding="12" CornerRadius="6" BorderBrush="#FCD34D" BorderThickness="1" Margin="6,0,0,12">
                                <StackPanel>
                                    <TextBlock Text="URLs Aprendidas" FontWeight="SemiBold" Foreground="#92400E" Margin="0,0,0,4" />
                                    <TextBox Text="{Binding LearnedUrlsText, UpdateSourceTrigger=PropertyChanged}" 
                                             Height="60" 
                                             AcceptsReturn="True" 
                                             VerticalScrollBarVisibility="Auto"
                                             FontFamily="Consolas"
                                             FontSize="10"
                                             Margin="0,0,0,8" />
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <Button Grid.Column="0" Content="Cargar" Command="{Binding LoadLearnedUrlsCommand}" Background="White" BorderBrush="#FCD34D" Foreground="#92400E" Margin="0,0,2,0" Padding="2" FontSize="10"/>
                                        <Button Grid.Column="1" Content="Guardar" Command="{Binding SaveLearnedUrlsCommand}" Background="White" BorderBrush="#FCD34D" Foreground="#92400E" Margin="2,0,2,0" Padding="2" FontSize="10"/>
                                        <Button Grid.Column="2" Content="Probar" Command="{Binding InspectUrlsCommand}" Background="#FCD34D" BorderBrush="#F59E0B" Foreground="#92400E" Margin="2,0,0,0" Padding="2" FontSize="10" FontWeight="Bold"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </ScrollViewer>

                    <!-- MAIN CONTENT (Column 1) -->
                    <Grid Grid.Column="1">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="200" />
                        </Grid.RowDefinitions>

                        <!-- Mensajes de Ayuda / Estado -->
                        <Border Grid.Row="0" Margin="0,0,0,12"
                                Background="#DBEAFE" BorderBrush="#3B82F6" BorderThickness="1" CornerRadius="6" Padding="10"
                                Visibility="{Binding IsFamiliesMode, Converter={StaticResource BoolToVisibility}}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE946;" Foreground="#1E40AF" Margin="0,0,8,0" FontSize="16" VerticalAlignment="Center" />
                                <TextBlock Text="Modo Familias activado: Navegará por categorías y extraerá variantes." Foreground="#1E3A8A" VerticalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <!-- Consola - AHORA TOMA EL ESPACIO PRINCIPAL -->
                        <Border Grid.Row="1" Background="#1F2937" Padding="0" CornerRadius="6" BorderBrush="#374151" BorderThickness="1" Margin="0,0,0,12">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>
                                <Border Background="#111827" Padding="12,8" CornerRadius="6,6,0,0" BorderBrush="#374151" BorderThickness="0,0,0,1">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="📡 Consola en tiempo real" Foreground="#10B981" FontWeight="SemiBold" VerticalAlignment="Center" />
                                        <TextBlock Text=" (scroll auto)" Foreground="#6B7280" FontSize="11" VerticalAlignment="Center" Margin="8,0,0,0" />
                                    </StackPanel>
                                </Border>
                                <ListBox Grid.Row="1" 
                                         ItemsSource="{Binding LiveLogs}"
                                         FontFamily="Consolas"
                                         FontSize="12"
                                         Background="Transparent"
                                         Foreground="#D1D5DB"
                                         BorderThickness="0"
                                         ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         Padding="8">
                                    <ListBox.ItemContainerStyle>
                                        <Style TargetType="ListBoxItem">
                                            <Setter Property="Padding" Value="2,1" />
                                            <Setter Property="Background" Value="Transparent" />
                                        </Style>
                                    </ListBox.ItemContainerStyle>
                                </ListBox>
                            </Grid>
                        </Border>

                        <GridSplitter Grid.Row="2" Height="4" HorizontalAlignment="Stretch" Background="#E5E7EB" ShowsPreview="True" Margin="0,0,0,12" />

                        <!-- Grid de Staging (Preview) -->
                        <Grid Grid.Row="3">
                             <Border Background="White" Padding="0" CornerRadius="6" BorderBrush="#E5E7EB" BorderThickness="1">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                    </Grid.RowDefinitions>
                                    <Border Background="#F9FAFB" Padding="12,8" CornerRadius="6,6,0,0" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
                                        <TextBlock Text="Productos en Staging (Vista Previa)" FontWeight="SemiBold" Foreground="#374151" />
                                    </Border>
                                    <DataGrid Grid.Row="1"
                                              ItemsSource="{Binding StagingProducts}"
                                              SelectedItem="{Binding SelectedStagingProduct}"
                                              AutoGenerateColumns="True"
                                              IsReadOnly="False"
                                              CanUserAddRows="False"
                                              BorderThickness="0" />
                                </Grid>
                            </Border>
                        </Grid>
                    </Grid>
                </Grid>
            </TabItem>

            <TabItem Header="SAE">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="Enviar seleccionado" Command="{Binding SendSelectedToSaeCommand}" Margin="0,0,8,0" />
                        <Button Content="Enviar pendientes" Command="{Binding SendPendingToSaeCommand}" Margin="0,0,8,0" />
                        <CheckBox Content="Programar envío"
                                  IsChecked="{Binding SaeScheduleEnabled}"
                                  Margin="12,0,8,0" />
                        <TextBlock Text="Cada (min):" VerticalAlignment="Center" />
                        <TextBox Text="{Binding SaeScheduleMinutes}" Width="60" Margin="6,0,0,0" />
                    </StackPanel>
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding StagingProducts}"
                              SelectedItem="{Binding SelectedStagingProduct}"
                              AutoGenerateColumns="True"
                              IsReadOnly="False"
                              CanUserAddRows="False" />
                </Grid>
            </TabItem>
        </TabControl>

        <StatusBar Grid.Row="3" Background="#111827">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" Foreground="White" />
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
